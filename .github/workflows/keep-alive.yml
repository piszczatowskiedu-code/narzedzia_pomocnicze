name: Keep Streamlit App Alive

on:
  schedule:
    - cron: '30 5 * * 1-5'
  workflow_dispatch:

jobs:
  ping-app:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Ping Streamlit App
        id: ping
        run: |
          APP_URL="${{ secrets.STREAMLIT_APP_URL }}"
          APP_URL="${APP_URL%/}"
          HEALTH_URL="${APP_URL}/?health=check"
          
          echo "ðŸš€ Streamlit Keep-Alive"
          echo "â° $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ðŸŽ¯ Target: $HEALTH_URL"
          echo ""
          
          # Ping 1: Wake up (5 minut timeout!)
          echo "ðŸ“¡ Ping 1: Wake up (timeout 5 min)..."
          echo "   Started: $(date '+%H:%M:%S')"
          
          START=$(date +%s)
          HTTP_RESPONSE=$(curl -sL -w "\n%{http_code}" --max-time 300 "$HEALTH_URL" 2>&1)
          CURL_EXIT=$?
          END=$(date +%s)
          DURATION=$((END - START))
          
          BODY=$(echo "$HTTP_RESPONSE" | head -n -1)
          CODE=$(echo "$HTTP_RESPONSE" | tail -1)
          
          echo "   Finished: $(date '+%H:%M:%S')"
          echo "   Duration: ${DURATION}s"
          echo "   Curl exit code: $CURL_EXIT"
          echo "   HTTP code: $CODE"
          echo "   Response: $BODY"
          
          # Diagnoza curl exit code
          case $CURL_EXIT in
            0) echo "   âœ… Curl: Success" ;;
            6) echo "   âŒ Curl: Could not resolve host" ;;
            7) echo "   âŒ Curl: Failed to connect" ;;
            28) echo "   âŒ Curl: Timeout" ;;
            *) echo "   âŒ Curl: Error code $CURL_EXIT" ;;
          esac
          
          echo "PING1_CODE=$CODE" >> $GITHUB_OUTPUT
          echo "PING1_RESPONSE=$BODY" >> $GITHUB_OUTPUT
          echo "PING1_TIME=$DURATION" >> $GITHUB_OUTPUT
          echo "PING1_CURL=$CURL_EXIT" >> $GITHUB_OUTPUT
          
          # JeÅ›li pierwszy ping nie zadziaÅ‚aÅ‚, sprÃ³buj bez health param
          if [ "$CURL_EXIT" != "0" ]; then
            echo ""
            echo "ðŸ“¡ Ping 1b: Try main URL..."
            MAIN_CODE=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 60 "$APP_URL" 2>&1)
            MAIN_EXIT=$?
            echo "   Main URL code: $MAIN_CODE (curl: $MAIN_EXIT)"
            echo "PING1B_CODE=$MAIN_CODE" >> $GITHUB_OUTPUT
          fi
          
          # Wait
          echo ""
          echo "â³ Waiting 15 seconds..."
          sleep 15
          
          # Ping 2: Verify
          echo ""
          echo "ðŸ“¡ Ping 2: Verify..."
          
          RESPONSE2=$(curl -sL --max-time 60 "$HEALTH_URL" 2>&1)
          CURL_EXIT2=$?
          CODE2=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 60 "$HEALTH_URL" 2>&1)
          
          echo "   HTTP code: $CODE2"
          echo "   Response: $RESPONSE2"
          echo "   Curl exit: $CURL_EXIT2"
          
          echo "PING2_CODE=$CODE2" >> $GITHUB_OUTPUT
          echo "PING2_RESPONSE=$RESPONSE2" >> $GITHUB_OUTPUT
          
          # Result
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ "$CODE2" = "200" ] && [ "$RESPONSE2" = "OK" ]; then
            echo "âœ… SUCCESS! App is alive and healthy!"
            echo "RESULT=success" >> $GITHUB_OUTPUT
          elif [ "$CODE2" = "200" ]; then
            echo "âœ… SUCCESS! App is responding."
            echo "RESULT=success" >> $GITHUB_OUTPUT
          elif [ "$CODE" = "200" ]; then
            echo "âš ï¸ PARTIAL: First ping worked, second failed."
            echo "RESULT=partial" >> $GITHUB_OUTPUT
          else
            echo "âŒ FAILED: Could not reach app."
            echo "RESULT=failed" >> $GITHUB_OUTPUT
          fi
          
      - name: DNS and Network Debug
        if: failure() || steps.ping.outputs.RESULT == 'failed'
        run: |
          APP_URL="${{ secrets.STREAMLIT_APP_URL }}"
          # WyciÄ…gnij domenÄ™
          DOMAIN=$(echo "$APP_URL" | sed -e 's|https://||' -e 's|/.*||')
          
          echo "ðŸ” Network Debug"
          echo "================"
          echo ""
          echo "Domain: $DOMAIN"
          echo ""
          echo "ðŸ“¡ DNS Lookup:"
          nslookup "$DOMAIN" || echo "DNS lookup failed"
          echo ""
          echo "ðŸ“¡ Ping test:"
          ping -c 3 "$DOMAIN" || echo "Ping failed"
          echo ""
          echo "ðŸ“¡ Curl verbose (first 30 lines):"
          curl -vL --max-time 30 "https://$DOMAIN" 2>&1 | head -30
          
      - name: Summary
        if: always()
        run: |
          echo "## ðŸŒŸ Streamlit Keep-Alive Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          RESULT="${{ steps.ping.outputs.RESULT }}"
          if [ "$RESULT" = "success" ]; then
            echo "### âœ… Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          elif [ "$RESULT" = "partial" ]; then
            echo "### âš ï¸ Status: PARTIAL" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Status: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ping | HTTP | Response | Time | Curl |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|----------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ Wake | ${{ steps.ping.outputs.PING1_CODE }} | \`${{ steps.ping.outputs.PING1_RESPONSE }}\` | ${{ steps.ping.outputs.PING1_TIME }}s | ${{ steps.ping.outputs.PING1_CURL }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2ï¸âƒ£ Verify | ${{ steps.ping.outputs.PING2_CODE }} | \`${{ steps.ping.outputs.PING2_RESPONSE }}\` | - | - |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Curl Exit Codes" >> $GITHUB_STEP_SUMMARY
          echo "- \`0\` = Success" >> $GITHUB_STEP_SUMMARY
          echo "- \`6\` = Could not resolve host" >> $GITHUB_STEP_SUMMARY
          echo "- \`7\` = Connection refused" >> $GITHUB_STEP_SUMMARY
          echo "- \`28\` = Timeout" >> $GITHUB_STEP_SUMMARY