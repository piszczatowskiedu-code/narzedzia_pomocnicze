name: Keep Streamlit App Alive

on:
  schedule:
    - cron: '30 5 * * 1-5'
  workflow_dispatch:

jobs:
  ping-app:
    runs-on: ubuntu-latest
    
    steps:
      - name: Debug - Check Secret Format
        run: |
          APP_URL="${{ secrets.STREAMLIT_APP_URL }}"
          
          echo "ğŸ” DEBUG INFO"
          echo "============="
          
          # SprawdÅº czy secret istnieje
          if [ -z "$APP_URL" ]; then
            echo "âŒ SECRET IS EMPTY!"
            exit 1
          fi
          
          # PokaÅ¼ dÅ‚ugoÅ›Ä‡ URL (bez ujawniania)
          echo "URL length: ${#APP_URL} characters"
          
          # SprawdÅº czy zaczyna siÄ™ od https
          if [[ "$APP_URL" == https://* ]]; then
            echo "âœ… URL starts with https://"
          else
            echo "âŒ URL does NOT start with https://"
          fi
          
          # SprawdÅº czy zawiera streamlit
          if [[ "$APP_URL" == *streamlit* ]]; then
            echo "âœ… URL contains 'streamlit'"
          else
            echo "âš ï¸ URL does not contain 'streamlit'"
          fi
          
          # SprawdÅº czy koÅ„czy siÄ™ na /
          if [[ "$APP_URL" == */ ]]; then
            echo "â„¹ï¸ URL ends with /"
          else
            echo "â„¹ï¸ URL does not end with /"
          fi
          
      - name: Ping with Full Debug Output
        run: |
          APP_URL="${{ secrets.STREAMLIT_APP_URL }}"
          
          # UsuÅ„ trailing slash jeÅ›li jest
          APP_URL="${APP_URL%/}"
          
          # Zbuduj health URL
          HEALTH_URL="${APP_URL}/?health=check"
          
          echo ""
          echo "ğŸ¯ Pinging: [URL HIDDEN]/?health=check"
          echo "â° Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # ========== PING 1: Podstawowy test ==========
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¡ TEST 1: Basic connectivity"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          curl -v --max-time 120 "$HEALTH_URL" 2>&1 | head -50
          
          echo ""
          echo ""
          
          # ========== PING 2: Tylko status ==========
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¡ TEST 2: Status check"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$HEALTH_URL" 2>&1) || HTTP_CODE="FAILED"
          echo "HTTP Status Code: $HTTP_CODE"
          
          echo ""
          
          # ========== PING 3: PeÅ‚na odpowiedÅº ==========
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¡ TEST 3: Response body"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          RESPONSE=$(curl -s --max-time 30 "$HEALTH_URL" 2>&1) || RESPONSE="[CURL FAILED]"
          echo "Response body:"
          echo "$RESPONSE" | head -20
          
          echo ""
          
          # ========== PING 4: Test bez health param ==========
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¡ TEST 4: Main URL (without health param)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          MAIN_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 "$APP_URL" 2>&1) || MAIN_CODE="FAILED"
          echo "Main URL HTTP Status: $MAIN_CODE"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Health endpoint status: $HTTP_CODE"
          echo "Main URL status: $MAIN_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed!"
          elif [ "$MAIN_CODE" = "200" ]; then
            echo "âš ï¸ Main URL works but health endpoint doesn't"
            echo "   â†’ Check if health check code is in your app"
          else
            echo "âŒ Both endpoints failed"
            echo "   â†’ Check if app URL is correct"
          fi