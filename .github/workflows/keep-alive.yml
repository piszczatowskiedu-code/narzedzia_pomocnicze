name: Keep Streamlit App Alive

on:
  schedule:
    - cron: '30 5 * * 1-5'
  workflow_dispatch:

jobs:
  ping-app:
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping Streamlit App
        id: ping
        run: |
          APP_URL="${{ secrets.STREAMLIT_APP_URL }}"
          APP_URL="${APP_URL%/}"
          HEALTH_URL="${APP_URL}/?health=check"
          
          echo "ðŸš€ Streamlit Keep-Alive"
          echo "â° $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # Ping 1: Wake up (z -L = follow redirects)
          echo "ðŸ“¡ Ping 1: Wake up..."
          RESPONSE1=$(curl -sL --max-time 120 "$HEALTH_URL" 2>&1) || RESPONSE1="ERROR"
          CODE1=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 120 "$HEALTH_URL" 2>&1) || CODE1="000"
          echo "   Status: $CODE1"
          echo "   Response: $RESPONSE1"
          
          echo "PING1_CODE=$CODE1" >> $GITHUB_OUTPUT
          echo "PING1_RESPONSE=$RESPONSE1" >> $GITHUB_OUTPUT
          
          # Wait
          echo ""
          echo "â³ Waiting 10 seconds..."
          sleep 10
          
          # Ping 2: Verify
          echo ""
          echo "ðŸ“¡ Ping 2: Verify..."
          RESPONSE2=$(curl -sL --max-time 30 "$HEALTH_URL" 2>&1) || RESPONSE2="ERROR"
          CODE2=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 30 "$HEALTH_URL" 2>&1) || CODE2="000"
          echo "   Status: $CODE2"
          echo "   Response: $RESPONSE2"
          
          echo "PING2_CODE=$CODE2" >> $GITHUB_OUTPUT
          echo "PING2_RESPONSE=$RESPONSE2" >> $GITHUB_OUTPUT
          
          # Result
          echo ""
          if [ "$CODE2" = "200" ] && [ "$RESPONSE2" = "OK" ]; then
            echo "âœ… SUCCESS! App is alive!"
            echo "RESULT=success" >> $GITHUB_OUTPUT
          elif [ "$CODE2" = "200" ]; then
            echo "âœ… SUCCESS! App responding."
            echo "RESULT=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ FAILED"
            echo "RESULT=failed" >> $GITHUB_OUTPUT
          fi
          
      - name: Summary
        if: always()
        run: |
          echo "## ðŸŒŸ Streamlit Keep-Alive Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.ping.outputs.RESULT }}" = "success" ]; then
            echo "### âœ… Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Status: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ping | Code | Response |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ Wake-up | ${{ steps.ping.outputs.PING1_CODE }} | \`${{ steps.ping.outputs.PING1_RESPONSE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 2ï¸âƒ£ Verify | ${{ steps.ping.outputs.PING2_CODE }} | \`${{ steps.ping.outputs.PING2_RESPONSE }}\` |" >> $GITHUB_STEP_SUMMARY